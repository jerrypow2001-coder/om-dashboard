<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OM Dashboard & Portfolios</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme Color for App Bar -->
    <meta name="theme-color" content="#4f46e5">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§¬</text></svg>">

    <!-- React & Tailwind Scripts -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#64748b',
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            input: '#334155',
                            border: '#334155',
                            text: '#f8fafc',
                            muted: '#94a3b8',
                            hover: '#334155'
                        }
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        @keyframes fadeInDown { from { opacity: 0; transform: translate3d(0, -10px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        .animate-fade-in { animation: fadeInDown 0.3s ease-out forwards; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        .bg-onco-light { background-image: linear-gradient(to bottom right, rgba(248, 250, 252, 0.92), rgba(224, 231, 255, 0.88)), url('https://images.unsplash.com/photo-1579165466741-7f35e4755657?auto=format&fit=crop&q=80&w=2070'); background-size: cover; background-position: center; background-attachment: fixed; }
        .bg-onco-dark { background-image: linear-gradient(to bottom right, rgba(15, 23, 42, 0.97), rgba(30, 41, 59, 0.95)), url('https://images.unsplash.com/photo-1579165466741-7f35e4755657?auto=format&fit=crop&q=80&w=2070'); background-size: cover; background-position: center; background-attachment: fixed; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="antialiased transition-colors duration-200">
    <div id="root"></div>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper: Date Calculations ---
        const getCurrentDateDetails = () => {
            const date = new Date();
            const month = date.getMonth() + 1; 
            const year = date.getFullYear();
            return { monthStr: `M${month.toString().padStart(2, '0')}`, monthNum: month, year: year };
        };

        const getExpectedVersion = (lag) => {
            const date = new Date();
            date.setMonth(date.getMonth() - lag);
            const m = date.getMonth() + 1;
            const y = date.getFullYear();
            return `M${m.toString().padStart(2, '0')} ${y}`;
        };

        const calculateQuarter = (versionStr) => {
            const match = versionStr.match(/M(\d+)/i);
            const yearMatch = versionStr.match(/\d{4}/);
            const year = yearMatch ? parseInt(yearMatch[0]) : new Date().getFullYear();
            if (!match) return versionStr;
            const m = parseInt(match[1], 10);
            if (m < 3) return `Q4 ${year - 1}`; 
            if (m < 6) return `Q1 ${year}`;
            if (m < 9) return `Q2 ${year}`;
            if (m < 12) return `Q3 ${year}`;
            return `Q4 ${year}`;
        };

        const formatDateKey = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const formatDateDisplay = (date) => {
            return date.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
        };

        // --- Icons ---
        const IconBase = ({ size = 20, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"></polyline></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconBase>;
        const Database = (props) => <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></IconBase>;
        const LayoutDashboard = (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></IconBase>;
        const CalendarIcon = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>;
        const ListCheck = (props) => <IconBase {...props}><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconBase>;
        const Tag = (props) => <IconBase {...props}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const FileSpreadsheet = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></IconBase>;
        const Presentation = (props) => <IconBase {...props}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></IconBase>;
        const CheckSquare = (props) => <IconBase {...props}><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></IconBase>;
        const Square = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></IconBase>;
        const Moon = (props) => <IconBase {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></IconBase>;

        // --- Constants ---
        const INITIAL_YEARS = [2025, 2026];
        const INITIAL_JOB_LABELS = ['USTOM', 'ETOM', 'EU Rapid Fire'];
        
        // Dynamic Defaults - Always calculated on fresh load
        const INITIAL_DB_VERSIONS = [
          { id: 'curr', label: 'Current Month', value: getCurrentDateDetails().monthStr, lag: 0 },
          { id: 'eu5', label: 'EU5 Database', value: getExpectedVersion(2), lag: 2 },
          { id: 'us', label: 'US Database', value: getExpectedVersion(2), lag: 2 },
          { id: 'jp', label: 'JP Database', value: calculateQuarter(getExpectedVersion(0)), lag: 0 },
          { id: 'rf', label: 'Rapid Fire NSCLC', value: getExpectedVersion(1), lag: 1 },
        ];
        
        // Cleared for template
        const INITIAL_PORTFOLIOS = [];
        const INITIAL_TODOS_FLAT = []; // Empty
        
        const SECTIONS_CONFIG = {
            monthly: { title: 'Monthly Deliverables', icon: <CalendarIcon size={20} />, color: 'text-indigo-600 dark:text-indigo-400', bg: 'bg-white/90 dark:bg-dark-card/90 backdrop-blur', border: 'border-l-4 border-l-indigo-500' },
            quarterly: { title: 'Quarterly Deliverables', icon: <Database size={20} />, color: 'text-teal-600 dark:text-teal-400', bg: 'bg-white/90 dark:bg-dark-card/90 backdrop-blur', border: 'border-l-4 border-l-teal-500' }
        };
        const PERIOD_OPTIONS = [...Array.from({length: 12}, (_, i) => `M${String(i+1).padStart(2, '0')}`), 'Q1', 'Q2', 'Q3', 'Q4'];

        // --- Components ---

        const HeaderBanner = () => (
            <div className="relative bg-gradient-to-r from-indigo-900 to-blue-800 text-white rounded-2xl overflow-hidden mb-8 shadow-lg transition-colors">
                <img src="https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?auto=format&fit=crop&w=1200&q=80" alt="Healthcare Background" className="absolute inset-0 w-full h-full object-cover opacity-20 mix-blend-overlay" />
                <div className="relative p-8 md:p-10 flex flex-col justify-center min-h-[140px]">
                    <div className="flex items-center gap-3 mb-2">
                        <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                            <LayoutDashboard size={24} className="text-white" />
                        </div>
                        <span className="text-xs font-bold uppercase tracking-widest text-indigo-200">Workspace</span>
                    </div>
                    <h1 className="text-3xl md:text-4xl font-bold tracking-tight mb-1 text-white">Oncology Monitor</h1>
                    <p className="text-indigo-100 text-sm md:text-base font-light max-w-xl">Track deliverables, manage databases, and monitor progress efficiently.</p>
                </div>
            </div>
        );

        const CalendarWidget = ({ selectedDate, onDateSelect, dailyLogs, allTodos }) => {
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
            const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September", "October", "November", "December"];
            
            const changeMonth = (delta) => {
                let newMonth = currentMonth + delta;
                let newYear = currentYear;
                if (newMonth > 11) { newMonth = 0; newYear++; } else if (newMonth < 0) { newMonth = 11; newYear--; }
                setCurrentMonth(newMonth); setCurrentYear(newYear);
            };
            const handleDayClick = (day) => { onDateSelect(new Date(currentYear, currentMonth, day)); };
            const isSelected = (day) => selectedDate.getDate() === day && selectedDate.getMonth() === currentMonth && selectedDate.getFullYear() === currentYear;
            const hasData = (day) => {
                const d = new Date(currentYear, currentMonth, day);
                const key = formatDateKey(d);
                return (dailyLogs[key] && dailyLogs[key].trim().length > 0) || (allTodos[key] && allTodos[key].length > 0);
            };
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-8"></div>);
            for (let i = 1; i <= daysInMonth; i++) {
                const active = isSelected(i);
                const marked = hasData(i);
                days.push(
                    <div key={i} onClick={() => handleDayClick(i)} className={`h-8 w-8 flex flex-col items-center justify-center rounded-full text-xs font-medium cursor-pointer transition-all relative ${active ? 'bg-indigo-600 text-white shadow-md transform scale-110' : 'text-slate-600 dark:text-slate-300 hover:bg-white/50 dark:hover:bg-dark-hover hover:text-indigo-600 dark:hover:text-indigo-400'}`}>
                        <span>{i}</span>
                        {marked && <span className={`w-1 h-1 rounded-full absolute bottom-1 ${active ? 'bg-white' : 'bg-rose-400'}`}></span>}
                    </div>
                );
            }
            return (
                <div className="bg-white/90 dark:bg-dark-card/90 backdrop-blur rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-5 h-full hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-4 border-b border-slate-100 dark:border-dark-border pb-3">
                        <div className="flex items-center gap-2"><CalendarIcon className="text-indigo-600 dark:text-indigo-400" size={18} /><h3 className="text-sm font-bold text-slate-700 dark:text-dark-text">{monthNames[currentMonth]} {currentYear}</h3></div>
                        <div className="flex gap-1"><button onClick={() => changeMonth(-1)} className="p-1 hover:bg-slate-100 dark:hover:bg-dark-hover rounded text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">&lt;</button><button onClick={() => changeMonth(1)} className="p-1 hover:bg-slate-100 dark:hover:bg-dark-hover rounded text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">&gt;</button></div>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center mb-2">{['S','M','T','W','T','F','S'].map((d,i) => <div key={i} className="text-[10px] font-bold text-slate-400 dark:text-dark-muted">{d}</div>)}</div>
                    <div className="grid grid-cols-7 gap-1 place-items-center">{days}</div>
                </div>
            );
        };

        const TodoWidget = ({ selectedDate, allTodos, setAllTodos }) => {
            const dateKey = formatDateKey(selectedDate);
            const displayDate = formatDateDisplay(selectedDate);
            const todos = allTodos[dateKey] || [];
            const [newTodo, setNewTodo] = useState('');
            const updateTodos = (newTodoList) => { setAllTodos({ ...allTodos, [dateKey]: newTodoList }); };
            const addTodo = (e) => { e.preventDefault(); if (!newTodo.trim()) return; updateTodos([...todos, { id: Date.now(), text: newTodo, completed: false }]); setNewTodo(''); };
            const toggleTodo = (id) => { updateTodos(todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t)); };
            const deleteTodo = (id) => { updateTodos(todos.filter(t => t.id !== id)); };
            return (
                <div className="bg-white/90 dark:bg-dark-card/90 backdrop-blur rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-5 h-full flex flex-col hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between gap-2 mb-3 border-b border-slate-100 dark:border-dark-border pb-3">
                        <div className="flex items-center gap-2"><ListCheck className="text-teal-600 dark:text-teal-400" size={18} /><h3 className="text-sm font-bold text-slate-700 dark:text-dark-text">To-Do List</h3></div>
                        <span className="text-[10px] font-bold text-teal-600 dark:text-teal-400 bg-teal-50 dark:bg-dark-input px-2 py-1 rounded-md border border-teal-100 dark:border-dark-border">{displayDate}</span>
                    </div>
                    <div className="flex-grow overflow-y-auto mb-3 space-y-2 pr-1 custom-scrollbar" style={{maxHeight: '160px'}}>
                        {todos.length === 0 && <p className="text-xs text-slate-400 dark:text-dark-muted italic text-center py-4">No tasks for today. Add one!</p>}
                        {todos.map(todo => (
                            <div key={todo.id} className="flex items-center group bg-slate-50/50 dark:bg-dark-input p-2 rounded-lg border border-transparent hover:border-slate-100 dark:hover:border-dark-border transition-colors">
                                <label className="flex items-center flex-grow gap-2 cursor-pointer"><input type="checkbox" checked={todo.completed} onChange={() => toggleTodo(todo.id)} className="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300 dark:border-slate-600 dark:bg-slate-700"/><span className={`text-sm ${todo.completed ? 'text-slate-400 dark:text-slate-500 line-through' : 'text-slate-700 dark:text-dark-text'}`}>{todo.text}</span></label>
                                <button onClick={() => deleteTodo(todo.id)} className="text-slate-300 dark:text-slate-500 hover:text-red-500 dark:hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-1"><Trash2 size={12} /></button>
                            </div>
                        ))}
                    </div>
                    <form onSubmit={addTodo} className="flex gap-2 mt-auto pt-2 border-t border-slate-50 dark:border-dark-border"><input type="text" className="flex-grow text-xs border border-slate-200 dark:border-dark-border dark:bg-dark-input dark:text-dark-text rounded-lg px-3 py-2 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-100 dark:focus:ring-indigo-900 transition-all" placeholder="Add new task..." value={newTodo} onChange={(e) => setNewTodo(e.target.value)}/><button type="submit" className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm"><Plus size={16} /></button></form>
                </div>
            );
        };

        const ProgressWidget = ({ selectedDate, dailyLogs, setDailyLogs }) => {
            const dateKey = formatDateKey(selectedDate);
            const displayDate = formatDateDisplay(selectedDate);
            const content = dailyLogs[dateKey] || "";
            const handleChange = (e) => { setDailyLogs({ ...dailyLogs, [dateKey]: e.target.value }); };
            return (
                <div className="bg-white/90 dark:bg-dark-card/90 backdrop-blur rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-5 h-full flex flex-col hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between gap-2 mb-3 border-b border-slate-100 dark:border-dark-border pb-3"><div className="flex items-center gap-2"><History className="text-amber-500" size={18} /><h3 className="text-sm font-bold text-slate-700 dark:text-dark-text">Daily Log</h3></div><span className="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-dark-input px-2 py-1 rounded-md border border-indigo-100 dark:border-dark-border">{displayDate}</span></div>
                    <textarea className="flex-grow w-full text-sm text-slate-700 dark:text-dark-text bg-slate-50/50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-100 dark:focus:ring-indigo-900 focus:border-indigo-300 resize-none transition-all placeholder:text-slate-400 dark:placeholder:text-dark-muted" placeholder={`Log notes for ${displayDate}...`} value={content} onChange={handleChange} style={{minHeight: '160px'}}/>
                </div>
            );
        };

        const ConfigurationPanel = ({ availableYears, availableJobLabels, resetData, addYear, removeYear, addJobLabel, removeJobLabel }) => (
              <div className="bg-white/90 dark:bg-dark-card/90 backdrop-blur border border-slate-200 dark:border-dark-border rounded-xl p-6 mb-8 shadow-sm">
                   <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><Settings className="text-indigo-600 dark:text-indigo-400" size={20} /><h3 className="text-base font-bold text-slate-800 dark:text-dark-text">Dashboard Configuration</h3></div><button onClick={resetData} className="text-xs flex items-center gap-1 text-slate-400 hover:text-red-500 px-2 py-1 rounded transition-colors" title="Reset all data to defaults"><RefreshCw size={12} /> Reset to Default</button></div>
                   <div className="space-y-4">
                       <div className="flex flex-col md:flex-row md:items-center gap-4 text-sm border-b border-slate-50 dark:border-slate-800 pb-4"><span className="font-bold text-slate-500 dark:text-dark-muted uppercase text-xs tracking-wider w-24">Years:</span><div className="flex flex-wrap gap-2">{availableYears.map(year => (<div key={year} className="bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border px-3 py-1.5 rounded-lg flex items-center gap-2 text-slate-700 dark:text-dark-text font-bold"><span>{year}</span><button onClick={() => removeYear(year)} className="text-slate-400 hover:text-red-500 transition-colors"><Trash2 size={12} /></button></div>))}<button onClick={addYear} className="bg-white dark:bg-dark-input text-indigo-600 dark:text-indigo-400 px-3 py-1.5 rounded-lg border-2 border-dashed border-indigo-200 dark:border-dark-border hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-dark-hover font-bold flex items-center gap-1 transition-all"><Plus size={12} /> Add</button></div></div>
                       <div className="flex flex-col md:flex-row md:items-center gap-4 text-sm"><span className="font-bold text-slate-500 dark:text-dark-muted uppercase text-xs tracking-wider w-24">Job Labels:</span><div className="flex flex-wrap gap-2">{availableJobLabels.map(label => (<div key={label} className="bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border px-3 py-1.5 rounded-lg flex items-center gap-2 text-slate-700 dark:text-dark-text font-bold"><span>{label}</span><button onClick={() => removeJobLabel(label)} className="text-slate-400 hover:text-red-500 transition-colors"><Trash2 size={12} /></button></div>))}<button onClick={addJobLabel} className="bg-white dark:bg-dark-input text-indigo-600 dark:text-indigo-400 px-3 py-1.5 rounded-lg border-2 border-dashed border-indigo-200 dark:border-dark-border hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-dark-hover font-bold flex items-center gap-1 transition-all"><Plus size={12} /> Add</button></div></div>
                   </div>
              </div>
        );

        const EditPortfolioModal = ({ portfolio, isOpen, onClose, onSave, allDbs, jobLabels }) => {
            if (!isOpen || !portfolio) return null;
            const [formData, setFormData] = useState({...portfolio});
            useEffect(() => { if(portfolio) setFormData({...portfolio}); }, [portfolio]);
            const handleChange = (field, value) => { setFormData(prev => ({...prev, [field]: value})); };
            const toggleDbRef = (dbId) => {
                const currentRefs = formData.dbRef || [];
                const newRefs = currentRefs.includes(dbId) ? currentRefs.filter(id => id !== dbId) : [...currentRefs, dbId];
                setFormData(prev => ({...prev, dbRef: newRefs}));
            };
            const toggleDeliverable = (type) => {
                const current = formData.deliverables || [];
                const newDel = current.includes(type) ? current.filter(t => t !== type) : [...current, type];
                setFormData(prev => ({...prev, deliverables: newDel}));
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white dark:bg-dark-card rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh] border border-slate-200 dark:border-dark-border">
                        <div className="p-4 border-b border-slate-100 dark:border-dark-border flex justify-between items-center bg-slate-50 dark:bg-dark-card">
                            <h3 className="font-bold text-slate-800 dark:text-dark-text flex items-center gap-2"><Edit2 size={16} className="text-indigo-600 dark:text-indigo-400"/> Edit Portfolio Details</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 p-1"><X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-5">
                            <div><label className="block text-xs font-bold text-slate-500 dark:text-dark-muted uppercase mb-1">Title</label><input className="w-full text-sm border border-slate-200 dark:border-dark-border rounded-lg p-2 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none dark:bg-dark-input dark:text-dark-text" value={formData.title} onChange={(e) => handleChange('title', e.target.value)}/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-dark-muted uppercase mb-1">Version</label><input className="w-full text-sm border border-slate-200 dark:border-dark-border rounded-lg p-2 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none dark:bg-dark-input dark:text-dark-text" value={formData.currentVersion} onChange={(e) => handleChange('currentVersion', e.target.value)}/></div>
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-dark-muted uppercase mb-1">Job Label</label><select className="w-full text-sm border border-slate-200 dark:border-dark-border rounded-lg p-2 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none bg-white dark:bg-dark-input dark:text-dark-text" value={formData.jobLabel} onChange={(e) => handleChange('jobLabel', e.target.value)}>{jobLabels.map(label => <option key={label} value={label}>{label}</option>)}</select></div>
                            </div>
                            <div><label className="block text-xs font-bold text-slate-500 dark:text-dark-muted uppercase mb-2">Deliverables</label><div className="flex gap-4"><label className="flex items-center gap-2 cursor-pointer text-sm text-slate-600 dark:text-dark-text"><input type="checkbox" checked={(formData.deliverables || []).includes('Excel')} onChange={() => toggleDeliverable('Excel')} className="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500"/> Excel</label><label className="flex items-center gap-2 cursor-pointer text-sm text-slate-600 dark:text-dark-text"><input type="checkbox" checked={(formData.deliverables || []).includes('PowerPoint')} onChange={() => toggleDeliverable('PowerPoint')} className="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500"/> PowerPoint</label></div></div>
                            <div><label className="block text-xs font-bold text-slate-500 dark:text-dark-muted uppercase mb-1">Scope</label><input className="w-full text-sm border border-slate-200 dark:border-dark-border rounded-lg p-2 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none dark:bg-dark-input dark:text-dark-text" value={formData.scope} onChange={(e) => handleChange('scope', e.target.value)}/></div>
                            <div><label className="block text-xs font-bold text-slate-500 dark:text-dark-muted uppercase mb-1">Remarks</label><textarea className="w-full text-sm border border-slate-200 dark:border-dark-border rounded-lg p-2 focus:ring-2 focus:ring-indigo-200 dark:focus:ring-indigo-900 outline-none h-32 resize-none dark:bg-dark-input dark:text-dark-text" value={formData.remarks} onChange={(e) => handleChange('remarks', e.target.value)} placeholder="Enter remarks..."/></div>
                            <div><label className="block text-xs font-bold text-slate-500 dark:text-dark-muted uppercase mb-2">Linked Databases</label><div className="flex flex-wrap gap-2">{allDbs.filter(d => d.id !== 'curr').map(db => (<label key={db.id} className={`flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded-lg border text-xs font-bold transition-all ${formData.dbRef.includes(db.id) ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-300' : 'bg-white dark:bg-dark-input border-slate-200 dark:border-dark-border text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-dark-hover'}`}><input type="checkbox" checked={formData.dbRef.includes(db.id)} onChange={() => toggleDbRef(db.id)} className="hidden"/>{formData.dbRef.includes(db.id) && <Check size={12}/>}{db.label}</label>))}</div></div>
                        </div>
                        <div className="p-4 border-t border-slate-100 dark:border-dark-border flex justify-end gap-3 bg-slate-50 dark:bg-slate-800/50"><button onClick={onClose} className="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-dark-hover rounded-lg transition-colors">Cancel</button><button onClick={() => onSave(formData)} className="px-6 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm transition-colors">Save Changes</button></div>
                    </div>
                </div>
            );
        };

        const App = () => {
          const [dbVersions, setDbVersions] = useState(INITIAL_DB_VERSIONS);
          const [portfolios, setPortfolios] = useState(INITIAL_PORTFOLIOS);
          const [allTodos, setAllTodos] = useState({}); 
          const [dailyLogs, setDailyLogs] = useState({});
          const [selectedDate, setSelectedDate] = useState(new Date());
          const [availableYears, setAvailableYears] = useState(INITIAL_YEARS);
          const [availableJobLabels, setAvailableJobLabels] = useState(INITIAL_JOB_LABELS);
          const [editMode, setEditMode] = useState(false);
          const [darkMode, setDarkMode] = useState(false);
          const [toast, setToast] = useState({ show: false, message: '' });
          
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingPortfolio, setEditingPortfolio] = useState(null);
          const [isDirty, setIsDirty] = useState(false);
          const initialLoadDone = useRef(false);

          useEffect(() => {
              const savedTheme = localStorage.getItem('omDashboardTheme');
              if (savedTheme === 'dark') setDarkMode(true);
          }, []);

          const verifiedDbs = useMemo(() => {
             return dbVersions.map(db => {
                let isUpdated = true;
                let expected = "";
                if (db.lag > 0 || db.lag === 0) { 
                    expected = getExpectedVersion(db.lag);
                    if (db.id !== 'curr' && db.lag !== undefined) {
                         if (db.value.includes('Q')) { isUpdated = true; } else { isUpdated = (db.value.trim().toLowerCase() === expected.toLowerCase()); }
                    }
                }
                if (db.id === 'curr') isUpdated = true;
                return { ...db, isUpdated, expected };
             });
          }, [dbVersions]);

          useEffect(() => {
            const savedData = localStorage.getItem('omDashboardData');
            const liveCurrentMonth = getCurrentDateDetails().monthStr;
            const todayKey = formatDateKey(new Date());
            if (savedData) {
              try {
                const parsed = JSON.parse(savedData);
                const migratedPortfolios = (parsed.portfolios || INITIAL_PORTFOLIOS).map(p => ({
                    ...p, type: p.type || 'monthly', dbRef: p.dbRef || [], jobLabel: p.jobLabel || 'ETOM', deliverables: p.deliverables || ['Excel'], completedDeliverables: p.completedDeliverables || (p.status === 'updated' ? (p.deliverables || ['Excel']) : [])
                }));
                const migratedDbs = (parsed.dbVersions || INITIAL_DB_VERSIONS).map(db => {
                    const defaultLag = (db.id === 'eu5' || db.id === 'us') ? 2 : (db.id === 'rf' ? 1 : 0);
                    const lag = db.lag !== undefined ? db.lag : defaultLag;
                    if (db.id === 'curr') return { ...db, value: liveCurrentMonth, lag: 0 };
                    return { ...db, lag };
                });
                setDbVersions(migratedDbs);
                setPortfolios(migratedPortfolios);
                if (Array.isArray(parsed.todos)) setAllTodos({ [todayKey]: parsed.todos }); else if (parsed.allTodos) setAllTodos(parsed.allTodos); else setAllTodos({ [todayKey]: INITIAL_TODOS_FLAT });
                let loadedLogs = parsed.dailyLogs || {};
                if (!parsed.dailyLogs && parsed.yesterdayProgress) { loadedLogs[formatDateKey(new Date())] = parsed.yesterdayProgress; }
                setDailyLogs(loadedLogs);
                setAvailableYears(parsed.availableYears || INITIAL_YEARS);
                setAvailableJobLabels(parsed.availableJobLabels || INITIAL_JOB_LABELS);
              } catch (e) { console.error("Failed to load saved data"); }
            } else { setDbVersions(prev => prev.map(db => db.id === 'curr' ? { ...db, value: liveCurrentMonth } : db)); setAllTodos({ [todayKey]: INITIAL_TODOS_FLAT }); }
            setTimeout(() => { initialLoadDone.current = true; }, 500);
          }, []);

          useEffect(() => { if (initialLoadDone.current) { setIsDirty(true); } }, [dbVersions, portfolios, allTodos, dailyLogs, availableYears, availableJobLabels]);
          useEffect(() => { const handleBeforeUnload = (e) => { if (isDirty) { e.preventDefault(); e.returnValue = ''; } }; window.addEventListener('beforeunload', handleBeforeUnload); return () => window.removeEventListener('beforeunload', handleBeforeUnload); }, [isDirty]);

          const toggleDarkMode = () => {
              setDarkMode(!darkMode);
              localStorage.setItem('omDashboardTheme', !darkMode ? 'dark' : 'light');
          };
          const showToast = (msg) => { setToast({ show: true, message: msg }); setTimeout(() => setToast({ show: false, message: '' }), 3000); };
          const saveToLocalStorage = () => { const dataToSave = { dbVersions, portfolios, allTodos, dailyLogs, availableYears, availableJobLabels }; localStorage.setItem('omDashboardData', JSON.stringify(dataToSave)); setIsDirty(false); showToast('Changes saved to browser!'); };
          const updateDb = (id, field, value) => { setDbVersions(prev => prev.map(d => d.id === id ? { ...d, [field]: value } : d)); };
          const addDb = () => { const id = `db_${Date.now()}`; setDbVersions([...dbVersions, { id, label: 'New Database', value: 'M01 2025', lag: 0 }]); };
          const deleteDb = (id) => { if (confirm("Delete this database?")) { setDbVersions(prev => prev.filter(d => d.id !== id)); setPortfolios(prev => prev.map(p => ({ ...p, dbRef: p.dbRef.filter(ref => ref !== id) }))); } };
          const updatePortfolio = (id, field, value) => { setPortfolios(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item)); };
          const addPortfolio = (type) => { const id = Date.now(); setPortfolios([...portfolios, { id, type, title: 'New Portfolio', currentVersion: type === 'quarterly' ? 'Q3 2025' : 'M10 2025', scope: 'Enter scope details...', remarks: 'Enter remarks...', status: 'pending', dbRef: [], jobLabel: 'ETOM', deliverables: ['Excel'], completedDeliverables: [] }]); };
          const deletePortfolio = (id) => { if (confirm("Delete this portfolio?")) { setPortfolios(prev => prev.filter(p => p.id !== id)); } };
          const toggleDeliverableCompletion = (portfolioId, type) => { setPortfolios(prev => prev.map(item => { if (item.id !== portfolioId) return item; const isCompleted = item.completedDeliverables.includes(type); let newCompleted = isCompleted ? item.completedDeliverables.filter(d => d !== type) : [...item.completedDeliverables, type]; const allDone = item.deliverables.every(d => newCompleted.includes(d)); const newStatus = allDone ? 'updated' : 'pending'; return { ...item, completedDeliverables: newCompleted, status: newStatus }; })); };
          const togglePortfolioStatus = (id) => { setPortfolios(prev => prev.map(item => { if (item.id === id) { const newStatus = item.status === 'updated' ? 'pending' : 'updated'; const newCompleted = newStatus === 'updated' ? [...item.deliverables] : []; return { ...item, status: newStatus, completedDeliverables: newCompleted }; } return item; })); };
          const resetData = () => { if (confirm("Reset all changes to defaults?")) { setDbVersions(INITIAL_DB_VERSIONS); setPortfolios(INITIAL_PORTFOLIOS); setAllTodos({[formatDateKey(new Date())]: INITIAL_TODOS_FLAT}); setDailyLogs({}); setAvailableYears(INITIAL_YEARS); setAvailableJobLabels(INITIAL_JOB_LABELS); setIsDirty(true); showToast('Data reset to defaults (Unsaved)'); } };
          const addYear = () => { const yearInput = prompt("Enter year to add (e.g. 2027):"); if (yearInput && /^\d{4}$/.test(yearInput)) { const y = parseInt(yearInput); if (!availableYears.includes(y)) { setAvailableYears([...availableYears, y].sort()); } } };
          const removeYear = (y) => { if (confirm(`Remove year ${y}?`)) { setAvailableYears(availableYears.filter(yr => yr !== y)); } };
          const addJobLabel = () => { const label = prompt("Enter new Job Label:"); if (label && !availableJobLabels.includes(label)) { setAvailableJobLabels([...availableJobLabels, label]); } };
          const removeJobLabel = (label) => { if (confirm(`Remove label "${label}"?`)) { setAvailableJobLabels(availableJobLabels.filter(l => l !== label)); } };
          const openEditModal = (portfolio) => { setEditingPortfolio(portfolio); setIsModalOpen(true); };
          const handleSaveModal = (updatedPortfolio) => { setPortfolios(prev => prev.map(p => p.id === updatedPortfolio.id ? updatedPortfolio : p)); setIsModalOpen(false); setEditingPortfolio(null); showToast('Portfolio details updated'); };

          const DbCard = ({ dbId, sectionType, showEditControls }) => {
            const db = verifiedDbs.find(d => d.id === dbId); if (!db) return null;
            const isAutoCurrent = db.id === 'curr';
            let displayValue = db.value; let displayLabel = db.label; let isOutdated = !db.isUpdated; let expectedMsg = db.expected ? `Exp: ${db.expected}` : '';
            if (sectionType === 'quarterly' && !db.value.includes('Q')) { const q = calculateQuarter(db.value); displayValue = q; if (isOutdated) expectedMsg = "Source Monthly DB Outdated"; }
            const parts = db.value.split(' '); const currentPeriod = parts[0] || 'M01'; const currentYear = parts[1] || availableYears[0] || new Date().getFullYear();
            const handlePeriodChange = (newPeriod) => { updateDb(db.id, 'value', `${newPeriod} ${currentYear}`); };
            const handleYearChange = (newYear) => { updateDb(db.id, 'value', `${currentPeriod} ${newYear}`); };
            return (
               <div className={`relative overflow-hidden bg-white/90 dark:bg-dark-card/90 backdrop-blur rounded-xl p-4 shadow-sm border transition-all hover:shadow-md ${isOutdated ? 'border-amber-400 border-l-4' : 'border-emerald-400 border-l-4 border-slate-100 dark:border-dark-border'}`}>
                <div className="flex justify-between items-start mb-2 gap-2">{editMode ? (<input className="text-[10px] font-bold uppercase tracking-wider text-slate-500 w-full border-b border-transparent focus:border-indigo-300 outline-none dark:bg-dark-input dark:text-dark-text" value={db.label} onChange={(e) => updateDb(db.id, 'label', e.target.value)}/>) : (<span className="text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-dark-muted truncate" title={displayLabel}>{displayLabel}</span>)}<div className="flex gap-1">{isOutdated ? <div className="text-amber-500" title={expectedMsg}><AlertCircle size={16} /></div> : <div className="text-emerald-500"><Check size={16} strokeWidth={3} /></div>}{editMode && !isAutoCurrent && showEditControls && (<button onClick={() => deleteDb(db.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={12} /></button>)}</div></div>
                {editMode && showEditControls ? (<div className="space-y-3 pt-1">{!isAutoCurrent && (<div className="flex gap-2"><select className="w-1/2 text-xs font-bold border rounded px-1 py-1.5 bg-slate-50 dark:bg-dark-input dark:text-dark-text dark:border-dark-border focus:border-indigo-500 outline-none" value={currentPeriod} onChange={(e) => handlePeriodChange(e.target.value)}>{PERIOD_OPTIONS.map(p => <option key={p} value={p}>{p}</option>)}</select><select className="w-1/2 text-xs font-bold border rounded px-1 py-1.5 bg-slate-50 dark:bg-dark-input dark:text-dark-text dark:border-dark-border focus:border-indigo-500 outline-none" value={currentYear} onChange={(e) => handleYearChange(e.target.value)}>{availableYears.map(y => <option key={y} value={y}>{y}</option>)}</select></div>)}<div className="flex items-center gap-2"><span className="text-[9px] text-slate-400 uppercase">Lag:</span><input type="number" className="w-12 text-xs border rounded px-1 py-0.5 dark:bg-dark-input dark:text-dark-text dark:border-dark-border" value={db.lag} onChange={(e) => updateDb(db.id, 'lag', parseInt(e.target.value))} disabled={isAutoCurrent}/><span className="text-[9px] text-slate-400">mth</span></div>{isOutdated && !isAutoCurrent && (<div className="text-[10px] text-amber-600 font-semibold bg-amber-50 dark:bg-amber-900/30 px-1 rounded inline-block">{expectedMsg}</div>)}</div>) : (<div><div className="flex items-end gap-2"><span className={`text-xl font-bold tracking-tight ${isOutdated ? 'text-amber-600' : 'text-slate-800 dark:text-dark-text'}`}>{displayValue}</span></div>{isOutdated && (<div className="text-[10px] text-amber-600 font-medium mt-1">{sectionType === 'quarterly' && !db.value.includes('Q') ? 'Update Monthly DB' : 'Update Required'}</div>)}</div>)}
              </div>
            );
          };

          const PortfolioSection = ({ type }) => {
            const config = SECTIONS_CONFIG[type];
            const rawPortfolios = portfolios.filter(p => p.type === type);
            const relevantDbIds = [...new Set(['curr', ...rawPortfolios.flatMap(p => p.dbRef), ...(type === 'monthly' ? ['eu5','us','rf'] : ['jp','eu5','us'])])];
            const displayDbIds = relevantDbIds.filter(id => verifiedDbs.find(d => d.id === id));

            const sortedPortfolios = useMemo(() => {
                return [...rawPortfolios].sort((a, b) => {
                    const getStatus = (item) => {
                        const linkedDbs = item.dbRef.map(refId => verifiedDbs.find(d => d.id === refId)).filter(Boolean);
                        const hasOutdatedDb = linkedDbs.some(d => !d.isUpdated);
                        let versionMismatch = false;
                        if (linkedDbs.length > 0) {
                            const refDb = linkedDbs[0];
                            let refVersion = refDb.value;
                            if (type === 'quarterly' && !refVersion.includes('Q')) refVersion = calculateQuarter(refVersion);
                            if (item.currentVersion.trim().toLowerCase() !== refVersion.toLowerCase()) versionMismatch = true;
                        }
                        const isAllDelivered = (item.deliverables || []).every(d => (item.completedDeliverables || []).includes(d));
                        return !isAllDelivered || hasOutdatedDb || versionMismatch;
                    };
                    const aIsBad = getStatus(a); const bIsBad = getStatus(b);
                    if (aIsBad === bIsBad) return 0; return aIsBad ? -1 : 1;
                });
            }, [rawPortfolios, verifiedDbs, type]);

            return (
                <div className={`rounded-2xl border border-slate-200 dark:border-dark-border p-5 space-y-5 h-full flex flex-col shadow-sm ${config.bg} ${config.border}`}>
                    <div className="flex items-center gap-3 pb-3 border-b border-slate-100 dark:border-dark-border"><div className={`p-2 rounded-lg bg-opacity-10 ${config.color.replace('text-', 'bg-')}`}><div className={config.color}>{config.icon}</div></div><h2 className="text-lg font-bold text-slate-800 dark:text-dark-text">{config.title}</h2></div>
                    <div className="space-y-3"><div className="flex justify-between items-center"><h3 className="text-[10px] font-bold text-slate-400 dark:text-dark-muted uppercase tracking-widest">Reference Databases</h3>{editMode && <button onClick={addDb} className="text-[10px] flex items-center gap-1 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-700 px-2 py-1 rounded transition-colors font-bold"><Plus size={10}/> Add New</button>}</div><div className="grid grid-cols-2 gap-4">{(editMode ? verifiedDbs.map(d => d.id) : displayDbIds).map(id => (<DbCard key={id} dbId={id} sectionType={type} showEditControls={true} />))}</div></div>
                    <div className="space-y-3 pt-2 flex-grow">
                        <div className="flex justify-between items-center"><h3 className="text-[10px] font-bold text-slate-400 dark:text-dark-muted uppercase tracking-widest">Portfolios</h3></div>
                        <div className="flex flex-col gap-4">
                            {sortedPortfolios.map((item) => {
                                const linkedDbs = item.dbRef.map(refId => verifiedDbs.find(d => d.id === refId)).filter(Boolean);
                                const hasOutdatedDb = linkedDbs.some(d => !d.isUpdated);
                                let versionMismatch = false;
                                if (linkedDbs.length > 0) {
                                    const refDb = linkedDbs[0];
                                    let refVersion = refDb.value;
                                    if (type === 'quarterly' && !refVersion.includes('Q')) refVersion = calculateQuarter(refVersion);
                                    if (item.currentVersion.trim().toLowerCase() !== refVersion.toLowerCase()) versionMismatch = true;
                                }
                                const isAllDelivered = (item.deliverables || []).every(d => (item.completedDeliverables || []).includes(d));
                                const isRedStatus = !isAllDelivered || hasOutdatedDb || versionMismatch;
                                const isGreenStatus = !isRedStatus;

                                return (
                                <div key={item.id} className={`group bg-white/90 dark:bg-dark-card/90 backdrop-blur rounded-xl shadow-sm border border-slate-200 dark:border-dark-border p-5 transition-all hover:shadow-md relative overflow-hidden ${isRedStatus ? 'ring-1 ring-rose-100 dark:ring-rose-900' : ''}`}>
                                  <div className={`absolute top-0 left-0 w-1.5 h-full ${isGreenStatus ? 'bg-emerald-500' : 'bg-rose-500'}`}></div>
                                  <div className="flex justify-between items-start mb-3 pl-3">
                                     <div className="pr-2 w-full">
                                        <div className="flex items-center gap-2 mb-2 flex-wrap">
                                            <span className="text-[10px] font-bold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded border border-indigo-100 dark:border-indigo-800 inline-flex items-center gap-1"><Tag size={10} /> {item.jobLabel}</span>
                                            {item.deliverables && item.deliverables.map(del => {
                                                const isDone = (item.completedDeliverables || []).includes(del);
                                                return (
                                                <button key={del} onClick={() => toggleDeliverableCompletion(item.id, del)} className={`text-[10px] font-bold px-2 py-1 rounded border inline-flex items-center gap-1 transition-all ${isDone ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 border-emerald-200 dark:border-emerald-800 hover:bg-emerald-200' : 'bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700 hover:border-slate-300'}`} title={isDone ? `Mark ${del} as pending` : `Mark ${del} as done`}>
                                                    {isDone ? <CheckSquare size={10}/> : <Square size={10}/>} {del === 'Excel' ? <FileSpreadsheet size={10} /> : <Presentation size={10} />} {del}
                                                </button>
                                            )})}
                                        </div>
                                        <h3 className="font-bold text-slate-800 dark:text-dark-text text-base leading-tight mb-2">{item.title}</h3>
                                        <div className="flex items-center gap-2"><span className="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600">{item.currentVersion}</span>{versionMismatch && !editMode && (<span className="text-[10px] text-rose-500 font-bold bg-rose-50 dark:bg-rose-900/30 px-2 py-0.5 rounded-full border border-rose-100 dark:border-rose-800 animate-pulse">Ver Mismatch</span>)}</div>
                                     </div>
                                     <div className="flex flex-col gap-2">
                                         <button onClick={() => togglePortfolioStatus(item.id)} className={`p-2 rounded-full transition-all shadow-sm flex-shrink-0 self-end ${isGreenStatus ? 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100' : 'bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 hover:bg-rose-100'}`}>{isGreenStatus ? <Check size={18} /> : <AlertCircle size={18} />}</button>
                                         {editMode && (
                                             <>
                                             <button onClick={() => openEditModal(item)} className="text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 self-end p-1 transition-colors" title="Edit Details"><Edit2 size={16} /></button>
                                             <button onClick={() => deletePortfolio(item.id)} className="text-slate-300 hover:text-red-500 dark:hover:text-red-400 self-end p-1 transition-colors" title="Delete"><Trash2 size={16} /></button>
                                             </>
                                         )}
                                     </div>
                                  </div>
                                  <div className="space-y-3 pl-3">
                                    {(hasOutdatedDb || versionMismatch) && !editMode && (<div className="flex flex-col gap-1">{hasOutdatedDb && <div className="text-[11px] text-rose-700 dark:text-rose-300 font-medium bg-rose-50 dark:bg-rose-900/30 px-2 py-1 rounded border border-rose-100 dark:border-rose-800">âš ï¸ Linked Database needs update</div>}{versionMismatch && <div className="text-[11px] text-amber-700 dark:text-amber-300 font-medium bg-amber-50 dark:bg-amber-900/30 px-2 py-1 rounded border border-amber-100 dark:border-amber-800">âš ï¸ Portfolio version mismatch</div>}</div>)}
                                    <div><p className="text-[10px] font-bold text-slate-400 dark:text-dark-muted uppercase tracking-wider mb-1">Scope</p><p className="text-sm text-slate-600 dark:text-dark-text">{item.scope}</p></div>
                                    <div className="bg-amber-50/50 dark:bg-amber-900/10 rounded-lg p-3 border border-amber-100/50 dark:border-amber-800/50"><p className="text-[10px] font-bold text-amber-600/70 dark:text-amber-400/70 uppercase tracking-wider mb-1">Remarks</p><p className="text-xs text-slate-600 dark:text-slate-300 italic leading-relaxed whitespace-pre-wrap">{item.remarks}</p></div>
                                  </div>
                                </div>
                            )})}
                            {editMode && (<button onClick={() => addPortfolio(type)} className="w-full py-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-400 dark:text-slate-500 font-bold text-xs hover:border-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center gap-2"><Plus size={16} /> Add {type === 'monthly' ? 'Monthly' : 'Quarterly'} Portfolio</button>)}
                        </div>
                    </div>
                </div>
            );
          };

          return (
            <div className={`min-h-screen pb-20 transition-colors duration-500 ${darkMode ? 'dark bg-onco-dark text-gray-100' : 'bg-onco-light text-slate-800'}`}>
              {toast.show && (<div className="fixed top-6 right-6 z-50 bg-slate-800 dark:bg-slate-700 text-white px-6 py-3 rounded-xl shadow-2xl animate-fade-in flex items-center font-medium"><Check className="w-5 h-5 mr-3 text-emerald-400" />{toast.message}</div>)}
              <EditPortfolioModal portfolio={editingPortfolio} isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveModal} allDbs={verifiedDbs} jobLabels={availableJobLabels} />
              
              <nav className="bg-white/80 dark:bg-dark-card/80 backdrop-blur-md border-b border-slate-200 dark:border-dark-border sticky top-0 z-20 transition-colors">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div className="flex justify-between h-16"><div className="flex items-center gap-2"><span className="font-bold text-lg text-slate-700 dark:text-dark-text tracking-tight">OM Dashboard</span></div><div className="flex items-center gap-3"><button onClick={toggleDarkMode} className="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">{darkMode ? <Sun size={20}/> : <Moon size={20}/>}</button><div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div><button onClick={saveToLocalStorage} className={`flex items-center gap-2 px-5 py-2 rounded-full text-sm font-bold shadow-sm transition-all ${isDirty ? 'bg-indigo-600 text-white hover:bg-indigo-700 ring-2 ring-indigo-300 ring-offset-2' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700'}`} title="Save changes"><Save size={16} /> {isDirty ? 'Save Changes' : 'Saved'}</button><button onClick={() => setEditMode(!editMode)} className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 ${editMode ? 'bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 ring-2 ring-indigo-500 ring-offset-2' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 hover:border-slate-300'}`}><Edit2 size={14} className={editMode ? "text-indigo-600 dark:text-indigo-400" : "text-slate-500 dark:text-slate-400"} />{editMode ? 'Done Editing' : 'Edit Mode'}</button></div></div></div>
              </nav>

              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
                <HeaderBanner />
                {editMode && <ConfigurationPanel availableYears={availableYears} availableJobLabels={availableJobLabels} resetData={resetData} addYear={addYear} removeYear={removeYear} addJobLabel={addJobLabel} removeJobLabel={removeJobLabel}/>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <CalendarWidget selectedDate={selectedDate} onDateSelect={setSelectedDate} dailyLogs={dailyLogs} allTodos={allTodos}/>
                    <TodoWidget selectedDate={selectedDate} allTodos={allTodos} setAllTodos={setAllTodos} />
                    <ProgressWidget selectedDate={selectedDate} dailyLogs={dailyLogs} setDailyLogs={setDailyLogs}/>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                     <PortfolioSection type="monthly" />
                     <PortfolioSection type="quarterly" />
                </div>
              </main>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>